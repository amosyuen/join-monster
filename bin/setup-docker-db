#!/bin/bash
set -e

RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
CYAN='\033[36m'
NC='\033[0m'

PG=1
MYSQL=1

while [[ $# -gt 0 ]]
do
  case $1 in
    -p|--no-pg)
      PG=0
    ;;
    -m|--no-mysql)
      MYSQL=0
    ;;
    *)
      echo unrecognized option $1
      exit 1
    ;;
  esac
  shift # past argument or value
done

export USER=root
export MYSQL_URL=mysql://$USER@localhost/
export PG_URL=pg://$USER@localhost/

if [ $MYSQL = 1 ]; then
  echo -e "$YELLOW setting up mysql server...$NC"
  echo -e "$CYAN export MYSQL_URL=$MYSQL_URL$NC"

  running=$(docker ps -f name=mariadb | wc -l)
  if [[ "$running" -eq "1" ]]
  then
    docker run --name mariadb -d --rm -e MYSQL_ROOT_HOST=% -e MYSQL_ALLOW_EMPTY_PASSWORD=true -p 3306:3306 mariadb:10.2 > /dev/null
  fi

  databases=""
  for i in {1..20}
  do
    databases=$(docker exec -i mariadb mysql <<< "show databases" 2> /dev/null) || true
    if [[ ! -z "$databases" ]]
    then
      break
    else
      sleep 1
    fi
  done
  if [[ -z "$databases" ]]
  then
    echo -e "$RED mysql server was not responding after 20 seconds...$NC"
    exit 1
  else
    if ! echo $databases | grep test1 > /dev/null
    then
      echo -e "$YELLOW creating database test1$NC"
      docker exec -i mariadb mysql <<< "CREATE DATABASE test1" > /dev/null
    fi
    if ! echo $databases | grep test2 > /dev/null
    then
      echo -e "$YELLOW creating database test2$NC"
      docker exec -i mariadb mysql <<< "CREATE DATABASE test2" > /dev/null
    fi
    echo -e "${GREEN} mysql server setup$NC\n"
  fi
fi

if [ $PG = 1 ]; then
  echo -e "$YELLOW setting up postgres server...$NC"
  echo -e "$CYAN export PG_URL=$PG_URL$NC"

  running=$(docker ps -f name=postgres | wc -l)
  if [[ "$running" -eq "1" ]]
  then
    docker run --name postgres -d --rm -e POSTGRES_USER=$USER -e POSTGRES_PASSWORD= -p 5432:5432 postgres:9.3 > /dev/null
  fi

  databases=""
  for i in {1..20}
  do
    databases=$(docker exec -i postgres psql <<< "\l" 2> /dev/null) || true
    if [[ ! -z "$databases" ]]
    then
      break
    else
      sleep 1
    fi
  done
  if [[ -z "$databases" ]]
  then
    echo -e "$RED postgres server was not responding after 20 seconds...$NC"
    exit 1
  else
    if ! echo $databases | grep test1 > /dev/null
    then
      echo -e "$YELLOW creating database test1$NC"
      docker exec -i postgres psql <<< "CREATE DATABASE test1" > /dev/null
    fi
    if ! echo $databases | grep test2 > /dev/null
    then
      echo -e "$YELLOW creating database test2$NC"
      docker exec -i postgres psql <<< "CREATE DATABASE test2" > /dev/null
    fi
    if ! echo $databases | grep demo > /dev/null
    then
      echo -e "$YELLOW creating database demo$NC"
      docker exec -i postgres psql <<< "CREATE DATABASE demo" > /dev/null
    fi
    echo -e "${GREEN} postgres server setup$NC\n"
  fi
fi